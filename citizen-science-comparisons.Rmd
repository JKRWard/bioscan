---
title: "Comparison Among Citizen Science Efforts"
author: "Jeff Oliver"
date: "August 28, 2018"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Comparing estimates of species richness among the two sampling types in the Bioscan project with that of iNaturalist. For these comparisons we are interested in _area_ estimates of species richness, rather than estimates for each site. 

# Methods
## Setup
Loading dependencies for data wrangling (`tidyr`) and data visualization (`ggplot2`).

```{r data-setup}
library("tidyr")
library("ggplot2")
bioscan <- read.csv(file = "data/BioScanData.csv")

# Drop any rows missing data
bioscan <- na.omit(bioscan)

# Identify those columns with species data
species.cols <- c(5:33)
```

We are thus going to calculate richness for the area based on Pollard walks, richness for the area based on Malaise traps, and richness for the area based on iNaturalist data. For all these calculations, we will only have a single number; to get an idea of variation, we'll use bootstrap resampling (with replacement) to get a mean richenss and some measure of uncertainty about this estimate. For the first two (Pollard walk and Malaise trap), the process will be:

1. Create a boostrapped sample of all sites for the collection method of interest. For example, if there are `r nrow(bioscan[bioscan$Collection.Method == "Malaise", ])` rows (sites) of Malaise trap data, we create a new data frame with `r nrow(bioscan[bioscan$Collection.Method == "Malaise", ])` rows of data sampled with replacement from the original data.
2. Perform richness calculation on that sample.
    1. Extract all columns with species counts
    2. Perform `colSums` calculation on columns with species counts
    3. Count all species with at least one individual present in at least one site
3. Store this richness value as the estimate of richness for that sample.
4. Repeat

For the iNaturalist data, will perform similar approach, but will need only to count number of unique values in species column to determine richness of bootstrapped sample. See `scripts/gbif-processing.sh` and `scripts/gbif-additional-processing.R` for details of the iNaturalist data. The data in the file of interest still needs to be geographically restricted. For now, we will just draw a rectangle that encapsulates the sites from bioscan and only include iNaturalist observations that are included in that rectangle.

```{r inaturalist-data-processing}
# Read in full data
inaturalist <- read.csv(file = "data/iNaturalist-clean.csv")

# Drop NAs (should have been done already, but just in case)
inaturalist <- na.omit(inaturalist)

# Determine boundaries of rectangle from Bioscan data
max.lon <- max(bioscan$Longitude)
min.lon <- min(bioscan$Longitude)
max.lat <- max(bioscan$Latitude)
min.lat <- min(bioscan$Latitude)

# Restrict iNaturalist data to that rectangle
inaturalist <- inaturalist[inaturalist$longitude >= min.lon &
                             inaturalist$longitude <= max.lon &
                             inaturalist$latitude >= min.lat &
                             inaturalist$latitude <= max.lat, ]
```

Need to make sure species names match up in the two data sources.
```{r taxonomy-reconcile}
# We want to make species column in iNaturalist match the format as in bioscan 
# data: Genus_species
inaturalist$species <- gsub(pattern = " ", 
                            replacement = "_", 
                            x = as.character(inaturalist$species))

# And need to make two adjustments to iNaturalist species so they match with 
# taxonomy used by bioscan
inaturalist$species[inaturalist$species == "Icaricia_acmon"] <- "Plebejus_acmon"
inaturalist$species[inaturalist$species == "Paratrytone_melane"] <- "Poanes_melane"

# Turn it back into a factor, which also means we've dropped unused levels
inaturalist$species <- as.factor(inaturalist$species)
```

## Richness calculation
To calculate species richness, we count, for each site/collection method combination, the number of species for which at least one individual was observed. Our data are currently organized so that a single row represents a single site/collection method combination, so we can perform this operation once for each row and store the data in a new column called `richness`.

```{r richness-bootstrapping}
# Split the two bioscan data into separate data frames for easier bootstrapping
malaise <- bioscan[bioscan$Collection.Method == "Malaise", ]
pollard <- bioscan[bioscan$Collection.Method == "Pollard Walk", ]

# Set up size of bootstrap and data frame to collect results
num.samples <- 100
bootstrapped.df <- data.frame(id = 1:num.samples,
                              Malaise = NA,
                              Pollard = NA,
                              iNaturalist = NA)

for (i in 1:num.samples) {
  bs.malaise <- malaise[sample(x = 1:nrow(malaise), size = nrow(malaise), replace = TRUE), ]
  bootstrapped.df$Malaise[i] <- sum(colSums(x = bs.malaise[, species.cols]) > 0)

  bs.pollard <- pollard[sample(x = 1:nrow(pollard), size = nrow(pollard), replace = TRUE), ]
  bootstrapped.df$Pollard[i] <- sum(colSums(x = bs.pollard[, species.cols]) > 0)
  
  bs.inaturalist <- inaturalist[sample(x = 1:nrow(inaturalist), size = nrow(inaturalist), replace = TRUE), ]
  bootstrapped.df$iNaturalist[i] <- length(unique(bs.inaturalist$species))
}
```

# Results
We can compare the three sources of richness visually with a boxplot (after reshaping our data):
```{r richness-boxplot, out.height = "250px"}
bootstrap.long <- gather(data = bootstrapped.df, key = "Collection.Method", value = "Richness", -id)

richness.boxplot <- ggplot(data = bootstrap.long, mapping = aes(x = Collection.Method, y = Richness)) +
  geom_boxplot() +
  xlab(label = "Collection Method") + 
  ylab(label = "Species Richness")
print(richness.boxplot)
```

We also would like to glance at the overlap and differences among the three collections, a Venn diagram works best. **Blech** This is pretty ugly and should be replace with a `ggplot2` approach. See example at [https://scriptsandstatistics.wordpress.com/2018/04/26/how-to-plot-venn-diagrams-using-r-ggplot2-and-ggforce/](https://scriptsandstatistics.wordpress.com/2018/04/26/how-to-plot-venn-diagrams-using-r-ggplot2-and-ggforce/).
```{r venn-diagram}
# Need to count the 7 categories
# Malise only
# Pollard only
# iNaturalist only
# Malaise + Pollard
# Malaise + iNaturalist
# Pollard + iNaturalist
# Malaise + Pollard + iNaturalist

# Start by pulling out species names for the two bioscans (only those with non-
# zero observations)
malaise.totals <- colSums(x = malaise[, species.cols])
malaise.species <- names(x = malaise.totals)[malaise.totals > 0]

pollard.totals <- colSums(x = pollard[, species.cols])
pollard.species <- names(x = pollard.totals)[pollard.totals > 0]

inaturalist.species <- unique(as.character(inaturalist$species))

all.species <- union(x = malaise.species,
                     y = union(x = pollard.species, y = inaturalist.species))

species.in.methods <- data.frame(species = all.species,
                                 malaise = all.species %in% malaise.species,
                                 pollard = all.species %in% pollard.species,
                                 inaturalist = all.species %in% inaturalist.species)
species.in.methods <- species.in.methods[order(species.in.methods$species), ]

# OMG this is so freaking ugly

malaise.only <- sum(species.in.methods$malaise & 
                      !species.in.methods$pollard &
                      !species.in.methods$inaturalist)
pollard.only <- sum(species.in.methods$pollard & 
                      !species.in.methods$malaise &
                      !species.in.methods$inaturalist)
inaturalist.only <- sum(species.in.methods$inaturalist & 
                          !species.in.methods$malaise &
                          !species.in.methods$pollard)
malaise.pollard <- sum(species.in.methods$malaise & 
                         species.in.methods$pollard)
malaise.inaturalist <- sum(species.in.methods$malaise & 
                             species.in.methods$inaturalist)
pollard.inaturalist <- sum(species.in.methods$pollard & 
                             species.in.methods$inaturalist)
# malaise.pollard <- sum(species.in.methods$malaise & 
#                          species.in.methods$pollard &
#                          !species.in.methods$inaturalist)
# malaise.inaturalist <- sum(species.in.methods$malaise & 
#                              species.in.methods$inaturalist &
#                              !species.in.methods$pollard)
# pollard.inaturalist <- sum(species.in.methods$pollard & 
#                              species.in.methods$inaturalist &
#                              !species.in.methods$malaise)
all.three <- sum(species.in.methods$malaise &
                   species.in.methods$pollard &
                   species.in.methods$inaturalist)
# install.packages("VennDiagram")
library("VennDiagram")
library("grid")
grid.newpage()
draw.triple.venn(area1 = length(malaise.species), 
                 area2 = length(pollard.species), 
                 area3 = length(inaturalist.species),
                 n12 = malaise.pollard,
                 n13 = malaise.inaturalist,
                 n23 = pollard.inaturalist,
                 n123 = all.three,
                 category = c("Malaise trap", "Pollard walk", "iNaturalist"),
                 lty = "blank",
                 fill = c("skyblue", "pink1", "mediumorchid"))
```