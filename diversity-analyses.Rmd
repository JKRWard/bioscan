---
title: "Diversity Analyses"
author: "Jeff Oliver"
date: "September 13, 2018"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Comparing diversity between Pollard walks and Malaise traps.

```{r load-dependencies}
library("vegan")
library("ggplot2")
library("tidyr")
source(file = "bioscan-functions.R")
bioscan <- CompleteBioscan()
```

Perform calculation for Shannon's diversity index, _H_.
```{r diversity-calculations}
# Identify those columns with species data
species.cols <- c(5:33)

# Create data frame with only individual counts for each species.
species.counts <- bioscan[, species.cols]

# Calculate Shannon's diversity for each site
shannons.h <- vegan::diversity(x = species.counts, index = "shannon")

# Create a data frame we'll use for plotting
diversity.long <- data.frame(Site.Number = bioscan$Site.Number,
                           Collection.Method = bioscan$Collection.Method,
                           Diversity = shannons.h)

# And another for t-tests of diversity
diversity.wide <- diversity.long %>% spread(key = Collection.Method, value = Diversity)
```

Run a paired t-test to see if the collection methods differ
```{r diversity-t-test}
diversity.t <- t.test(x = diversity.wide$Malaise, 
                      y = diversity.wide$`Pollard Walk`,
                      paired = TRUE)

# Have to do some formatting if p-value is really low, otherwise it just gets 
# reported as "0"
p.value <- "< 0.001"
if (diversity.t$p.value > 0.001) {
  p.value <- paste0("= ", round(diversity.t$p.value, 3))
}
```

The t-test shows a significant difference between the two collection methods (_t_ = `r round(diversity.t$statistic, 3)`, _p_ `r p.value`, 95%CI of the mean difference between Maliase traps and Pollard walks [`r round(diversity.t$conf.int[[1]], 3)`, `r round(diversity.t$conf.int[[2]], 3)`]). On average, $H_{Pollard \ walks}$ was `r abs(round(diversity.t$estimate, 3))` than $H_{Malaise \ traps}$.

We can compare the two types visually with a boxplot:
```{r diversity-boxplot, out.height = "250px"}
diversity.boxplot <- ggplot(data = diversity.long, mapping = aes(x = Collection.Method, y = Diversity)) +
  geom_boxplot() +
  xlab(label = "Collection Method") + 
  ylab(label = "Shannon's H") + 
  theme_bw()
print(diversity.boxplot)
ggsave(filename = "output/figure-diversity-pairwise.png", plot = diversity.boxplot)
```